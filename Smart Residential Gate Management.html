<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Residential Gate Management System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .system-header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .system-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .system-header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .main-interface {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .kiosk-panel, .resident-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .panel-header {
            text-align: center;
            margin-bottom: 25px;
        }

        .panel-header h2 {
            color: #333;
            margin-bottom: 10px;
        }

        .security-status {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }

        .status-indicator {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            color: white;
            font-weight: bold;
            margin: 5px;
        }

        .normal { background: #28a745; }
        .late { background: #ffc107; color: #000; }
        .lockdown { background: #dc3545; }

        .action-buttons {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 15px 25px;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #000;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .voice-interface {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .voice-status {
            text-align: center;
            margin-bottom: 15px;
        }

        .listening-indicator {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #dc3545;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .listening-indicator.active {
            background: #28a745;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .conversation-log {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            height: 200px;
            overflow-y: auto;
            padding: 15px;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
        }

        .system-message {
            background: #e3f2fd;
            color: #1976d2;
        }

        .user-message {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        .login-form {
            display: none;
        }

        .login-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }

        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: block;
        }

        .notification-panel {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .visitor-request {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .visitor-photo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 15px;
        }

        .cctv-feed {
            width: 100%;
            height: 200px;
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 20px;
        }

        .entries-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .entry-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .main-interface {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="system-header">
            <h1>Smart Residential Gate Management</h1>
            <p>ML-Based Visitor Authentication and Access Control</p>
        </div>

        <div class="main-interface">
            <!-- Gate Kiosk Panel -->
            <div class="kiosk-panel">
                <div class="panel-header">
                    <h2>üö™ Gate Kiosk Interface</h2>
                    <p>Voice-Based Interaction System</p>
                </div>

                <div class="security-status">
                    <h4>Current Security Mode</h4>
                    <span class="status-indicator normal" id="securityMode">Normal Hours</span>
                    <p><small>6 AM - 10 PM: Face Recognition | 10 PM - 6 AM: Face + Voice</small></p>
                </div>

                <div class="voice-interface">
                    <div class="voice-status">
                        <div class="listening-indicator" id="listeningIndicator">üé§</div>
                        <p id="voiceStatus">Press "Start Conversation" to begin</p>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="startConversation()">Start Conversation</button>
                        <button class="btn btn-success" onclick="simulateFaceRecognition()">Simulate Face Recognition</button>
                        <button class="btn btn-danger" onclick="emergencyAccess()">Emergency Access</button>
                    </div>

                    <div class="conversation-log" id="conversationLog">
                        <div class="message system-message">System ready. Waiting for visitor...</div>
                    </div>
                </div>
            </div>

            <!-- Resident Panel -->
            <div class="resident-panel">
                <div class="panel-header">
                    <h2>üè† Resident Dashboard</h2>
                    <p>Visitor Management & Monitoring</p>
                </div>

                <!-- Login Form -->
                <div class="login-form active" id="loginForm">
                    <div class="form-group">
                        <label for="loginApt">Apartment Number</label>
                        <input type="text" class="form-control" id="loginApt" placeholder="e.g., A-101" value="A-101">
                    </div>
                    <div class="form-group">
                        <label for="loginPass">Password</label>
                        <input type="password" class="form-control" id="loginPass" placeholder="Enter password" value="demo123">
                    </div>
                    <button class="btn btn-primary" onclick="login()">Login</button>
                    <p><small>Demo: A-101 / demo123 or B-205 / demo123</small></p>
                </div>

                <!-- Dashboard -->
                <div class="dashboard" id="dashboard">
                    <div class="notification-panel" id="notificationPanel" style="display: none;">
                        <h4>üîî Visitor Request</h4>
                        <div id="visitorRequests"></div>
                    </div>

                    <div class="cctv-feed" id="cctvFeed">
                        üìπ Live CCTV Feed - Gate Camera
                        <br><small>Click to view full screen</small>
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="checkPendingRequests()">Check Visitor Requests</button>
                        <button class="btn btn-warning" onclick="viewRecentEntries()">Recent Entries</button>
                        <button class="btn btn-danger" onclick="logout()">Logout</button>
                    </div>

                    <div class="entries-list" id="entriesList"></div>
                </div>
            </div>
        </div>

        <div id="alertContainer"></div>
    </div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let authToken = null;
        let conversationState = 'idle';
        let currentConversation = {};

        // Voice interaction simulation
        function addMessage(text, type = 'system') {
            const log = document.getElementById('conversationLog');
            const message = document.createElement('div');
            message.className = `message ${type}-message`;
            message.textContent = `${new Date().toLocaleTimeString()}: ${text}`;
            log.appendChild(message);
            log.scrollTop = log.scrollHeight;
        }

        function showAlert(message, type = 'success') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            
            setTimeout(() => {
                container.removeChild(alert);
            }, 5000);
        }

        async function startConversation() {
            conversationState = 'listening';
            document.getElementById('listeningIndicator').classList.add('active');
            document.getElementById('voiceStatus').textContent = 'Listening... Please speak';
            
            addMessage("Welcome to Sunrise Apartments! How can I help you today?", "system");
            
            // Simulate voice interaction
            setTimeout(() => {
                simulateVoiceInput();
            }, 2000);
        }

        function simulateVoiceInput() {
            const responses = [
                "I want to visit someone",
                "I have a delivery", 
                "Emergency! I need immediate access",
                "I'm here to see Mr. Sharma"
            ];
            
            const response = responses[Math.floor(Math.random() * responses.length)];
            addMessage(response, "user");
            
            document.getElementById('listeningIndicator').classList.remove('active');
            document.getElementById('voiceStatus').textContent = 'Processing...';
            
            processVoiceCommand(response);
        }

        function processVoiceCommand(command) {
            if (command.includes('visit')) {
                handleVisitorFlow();
            } else if (command.includes('delivery')) {
                handleDeliveryFlow();
            } else if (command.includes('emergency')) {
                handleEmergencyFlow();
            } else {
                addMessage("I understand you want to visit someone. What is your name?", "system");
                setTimeout(() => {
                    addMessage("Raj Kumar", "user");
                    continueVisitorFlow();
                }, 1500);
            }
        }

        function handleVisitorFlow() {
            addMessage("What is your name?", "system");
            setTimeout(() => {
                addMessage("Raj Kumar", "user");
                setTimeout(() => {
                    addMessage("Who would you like to visit? Please mention apartment number.", "system");
                    setTimeout(() => {
                        addMessage("Mr. Sharma in A-101", "user");
                        continueVisitorFlow();
                    }, 1500);
                }, 1500);
            }, 1500);
        }

        function continueVisitorFlow() {
            setTimeout(() => {
                addMessage("What is the purpose of your visit?", "system");
                setTimeout(() => {
                    addMessage("Personal visit", "user");
                    setTimeout(() => {
                        addMessage("Thank you Raj. I'm taking your photo and sending request to A-101. Please wait.", "system");
                        submitVisitorRequest();
                    }, 1500);
                }, 1500);
            }, 1500);
        }

        function handleDeliveryFlow() {
            addMessage("Which apartments are you delivering to?", "system");
            setTimeout(() => {
                addMessage("A-101 and B-205", "user");
                setTimeout(() => {
                    addMessage("What is your name and company?", "system");
                    setTimeout(() => {
                        addMessage("I'm Ravi from Swiggy", "user");
                        setTimeout(() => {
                            addMessage("Would you like to wait for approval or use delivery room?", "system");
                            setTimeout(() => {
                                addMessage("Delivery room please", "user");
                                addMessage("QR code printed! Please attach to packages and proceed to delivery room.", "system");
                            }, 1500);
                        }, 1500);
                    }, 1500);
                }, 1500);
            }, 1500);
        }

        function handleEmergencyFlow() {
            addMessage("Emergency protocol activated. Please show ID to camera.", "system");
            setTimeout(() => {
                addMessage("Emergency access granted. All residents notified. Gate opening now.", "system");
                emergencyAccess();
            }, 2000);
        }

        async function submitVisitorRequest() {
            try {
                const response = await fetch(`${API_BASE}/visitor-request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'Raj Kumar',
                        host_apartment: 'A-101',
                        purpose: 'Personal visit'
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    showAlert(data.message, 'success');
                    checkPendingRequestsAuto();
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Visitor request sent successfully (demo mode)', 'success');
            }
            
            document.getElementById('voiceStatus').textContent = 'Conversation complete';
            conversationState = 'idle';
        }

        async function simulateFaceRecognition() {
            document.getElementById('voiceStatus').textContent = 'Scanning face...';
            addMessage("Face detected. Processing recognition...", "system");
            
            try {
                const response = await fetch(`${API_BASE}/face-recognition`, {
                    method: 'POST'
                });
                
                const data = await response.json();
                if (data.success) {
                    addMessage(`Welcome home, ${data.resident.name}`, "system");
                    showAlert(`Gate opened for ${data.resident.name}`, 'success');
                } else {
                    addMessage("Face not recognized. Please use visitor process.", "system");
                }
            } catch (error) {
                // Demo mode
                const residents = ['John Sharma (A-101)', 'Priya Patel (B-205)'];
                const resident = residents[Math.floor(Math.random() * residents.length)];
                addMessage(`Welcome home, ${resident}`, "system");
                showAlert(`Gate opened for ${resident}`, 'success');
            }
            
            document.getElementById('voiceStatus').textContent = 'Ready for next person';
        }

        async function emergencyAccess() {
            addMessage("üö® EMERGENCY ACCESS ACTIVATED", "system");
            
            try {
                const response = await fetch(`${API_BASE}/emergency-access`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        service_type: 'Ambulance',
                        details: 'Medical emergency'
                    })
                });
                
                const data = await response.json();
                showAlert('üö® Emergency access granted - All residents alerted', 'danger');
            } catch (error) {
                showAlert('üö® Emergency access granted - All residents alerted', 'danger');
            }
        }

        // Resident Dashboard Functions
        async function login() {
            const apartment = document.getElementById('loginApt').value;
            const password = document.getElementById('loginPass').value;
            
            try {
                const response = await fetch(`${API_BASE}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ apartment, password })
                });
                
                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    authToken = data.token;
                    localStorage.setItem('authToken', authToken);
                    showDashboard();
                    showAlert(`Welcome, ${data.user.name}!`, 'success');
                    checkPendingRequestsAuto();
                } else {
                    showAlert('Invalid credentials', 'danger');
                }
            } catch (error) {
                // Demo mode
                if (apartment === 'A-101' && password === 'demo123') {
                    currentUser = { apartment: 'A-101', name: 'John Sharma' };
                    showDashboard();
                    showAlert('Welcome, John Sharma! (Demo Mode)', 'success');
                    checkPendingRequestsAuto();
                } else if (apartment === 'B-205' && password === 'demo123') {
                    currentUser = { apartment: 'B-205', name: 'Priya Patel' };
                    showDashboard();
                    showAlert('Welcome, Priya Patel! (Demo Mode)', 'success');
                } else {
                    showAlert('Invalid credentials. Try A-101/demo123', 'danger');
                }
            }
        }

        function showDashboard() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('dashboard').classList.add('active');
        }

        function logout() {
            currentUser = null;
            authToken = null;
            localStorage.removeItem('authToken');
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('notificationPanel').style.display = 'none';
            showAlert('Logged out successfully', 'success');
        }

        async function checkPendingRequests() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/pending-requests/${currentUser.apartment}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                if (data.success && data.requests.length > 0) {
                    displayVisitorRequests(data.requests);
                } else {
                    showAlert('No pending visitor requests', 'success');
                }
            } catch (error) {
                // Demo mode - simulate pending request
                if (Math.random() > 0.5) {
                    displayVisitorRequests([{
                        id: 1,
                        visitor_name: 'Raj Kumar',
                        purpose: 'Personal visit',
                        photo: 'demo_visitor.jpg'
                    }]);
                } else {
                    showAlert('No pending visitor requests', 'success');
                }
            }
        }

        function checkPendingRequestsAuto() {
            setTimeout(checkPendingRequests, 2000);
        }

        function displayVisitorRequests(requests) {
            const panel = document.getElementById('notificationPanel');
            const container = document.getElementById('visitorRequests');
            
            container.innerHTML = '';
            requests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'visitor-request';
                requestDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="width: 60px; height: 60px; background: #ddd; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center;">üì∑</div>
                        <div>
                            <h5>${request.visitor_name}</h5>
                            <p>Purpose: ${request.purpose}</p>
                            <small>Waiting for approval...</small>
                        </div>
                    </div>
                    <div class="action-buttons" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                        <button class="btn btn-success" onclick="approveVisitor(${request.id}, true)">Approve</button>
                        <button class="btn btn-warning" onclick="startIntercom()">Intercom</button>
                        <button class="btn btn-danger" onclick="approveVisitor(${request.id}, false)">Deny</button>
                    </div>
                `;
                container.appendChild(requestDiv);
            });
            
            panel.style.display = 'block';
        }

        async function approveVisitor(visitorId, approved) {
            try {
                const response = await fetch(`${API_BASE}/approve-visitor`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify({ visitor_id: visitorId, approved })
                });
                
                const data = await response.json();
                showAlert(data.message, approved ? 'success' : 'danger');
                document.getElementById('notificationPanel').style.display = 'none';
            } catch (error) {
                const message = approved ? 'Visitor approved! Gate opening.' : 'Visitor denied.';
                showAlert(message, approved ? 'success' : 'danger');
                document.getElementById('notificationPanel').style.display = 'none';
            }
        }

        function startIntercom() {
            showAlert('üé§ Intercom connected. You can now speak with the visitor.', 'warning');
            setTimeout(() => {
                showAlert('Intercom ended.', 'success');
            }, 5000);
        }

        async function viewRecentEntries() {
            if (!currentUser) return;
            
            try {
                const response = await fetch(`${API_BASE}/recent-entries/${currentUser.apartment}`, {
                    headers: { 'Authorization': `Bearer ${authToken}` }
                });
                
                const data = await response.json();
                displayRecentEntries(data.entries || []);
            } catch (error) {
                // Demo data
                const demoEntries = [
                    { name: 'Raj Kumar', purpose: 'Personal visit', time: '2024-01-15 14:30', status: 'approved' },
                    { name: 'Swiggy Delivery', purpose: 'Food delivery', time: '2024-01-15 12:15', status: 'delivered' },
                    { name: 'Amazon Delivery', purpose: 'Package delivery', time: '2024-01-14 16:45', status: 'delivery_room' }
                ];
                displayRecentEntries(demoEntries);
            }
        }

        function displayRecentEntries(entries) {
            const container = document.getElementById('entriesList');
            container.innerHTML = '<h4>Recent Entries</h4>';
            
            if (entries.length === 0) {
                container.innerHTML += '<p>No recent entries found.</p>';
                return;
            }
            
            entries.forEach(entry => {
                const entryDiv = document.createElement('div');
                entryDiv.className = 'entry-item';
                entryDiv.innerHTML = `
                    <div>
                        <strong>${entry.name}</strong><br>
                        <small>${entry.purpose} ‚Ä¢ ${entry.time}</small>
                    </div>
                    <div>
                        <span class="status-indicator ${entry.status}">${entry.status.toUpperCase()}</span>
                    </div>
                `;
                container.appendChild(entryDiv);
            });
        }

        // Initialize system
        function updateSecurityMode() {
            const hour = new Date().getHours();
            const modeElement = document.getElementById('securityMode');
            
            if (hour >= 22 || hour < 6) {
                modeElement.textContent = 'Late Hours';
                modeElement.className = 'status-indicator late';
            } else {
                modeElement.textContent = 'Normal Hours';
                modeElement.className = 'status-indicator normal';
            }
        }

        // Auto-login if token exists
        window.onload = function() {
            updateSecurityMode();
            setInterval(updateSecurityMode, 60000); // Update every minute
            
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                authToken = savedToken;
                // Auto-login demo user
                currentUser = { apartment: 'A-101', name: 'John Sharma' };
                showDashboard();
            }
        };
    </script>
</body>
</html>
